import{g as H,r as w,bF as Q,bG as W,cn as L,co as Z,u as J,j as z,c as O,cp as D,cq as tt}from"./sanity-3b6b2486.js";import{c as et,a as rt,g as it,b as F}from"./PresentationToolGrantsCheck-64b6d042.js";import{u as nt,a as st,b as ot}from"./hooks-0759ae97.js";import"./DisplayedDocumentBroadcaster-97a89245.js";function T(r){if(typeof r!="function")throw new Error("obliterator/iterator: expecting a function!");this.next=r}typeof Symbol<"u"&&(T.prototype[Symbol.iterator]=function(){return this});T.of=function(){var r=arguments,t=r.length,e=0;return new T(function(){return e>=t?{done:!0}:{done:!1,value:r[e++]}})};T.empty=function(){var r=new T(function(){return{done:!0}});return r};T.fromSequence=function(r){var t=0,e=r.length;return new T(function(){return t>=e?{done:!0}:{done:!1,value:r[t++]}})};T.is=function(r){return r instanceof T?!0:typeof r=="object"&&r!==null&&typeof r.next=="function"};var at=T,x={};x.ARRAY_BUFFER_SUPPORT=typeof ArrayBuffer<"u";x.SYMBOL_SUPPORT=typeof Symbol<"u";var G=x,ut=G.ARRAY_BUFFER_SUPPORT,ht=G.SYMBOL_SUPPORT,B=function(t,e){var n,i,s,a,h;if(!t)throw new Error("obliterator/forEach: invalid iterable.");if(typeof e!="function")throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(t)||ut&&ArrayBuffer.isView(t)||typeof t=="string"||t.toString()==="[object Arguments]"){for(s=0,a=t.length;s<a;s++)e(t[s],s);return}if(typeof t.forEach=="function"){t.forEach(e);return}if(ht&&Symbol.iterator in t&&typeof t.next!="function"&&(t=t[Symbol.iterator]()),typeof t.next=="function"){for(n=t,s=0;h=n.next(),h.done!==!0;)e(h.value,s),s++;return}for(i in t)t.hasOwnProperty(i)&&e(t[i],i)},j={};(function(r){var t=Math.pow(2,8)-1,e=Math.pow(2,16)-1,n=Math.pow(2,32)-1,i=Math.pow(2,7)-1,s=Math.pow(2,15)-1,a=Math.pow(2,31)-1;r.getPointerArray=function(u){var o=u-1;if(o<=t)return Uint8Array;if(o<=e)return Uint16Array;if(o<=n)return Uint32Array;throw new Error("mnemonist: Pointer Array of size > 4294967295 is not supported.")},r.getSignedPointerArray=function(u){var o=u-1;return o<=i?Int8Array:o<=s?Int16Array:o<=a?Int32Array:Float64Array},r.getNumberType=function(u){return u===(u|0)?Math.sign(u)===-1?u<=127&&u>=-128?Int8Array:u<=32767&&u>=-32768?Int16Array:Int32Array:u<=255?Uint8Array:u<=65535?Uint16Array:Uint32Array:Float64Array};var h={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};r.getMinimalRepresentation=function(u,o){var f=null,p=0,y,v,m,d,l;for(d=0,l=u.length;d<l;d++)m=o?o(u[d]):u[d],v=r.getNumberType(m),y=h[v.name],y>p&&(p=y,f=v);return f},r.isTypedArray=function(u){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView(u)},r.concat=function(){var u=0,o,f,p;for(o=0,p=arguments.length;o<p;o++)u+=arguments[o].length;var y=new arguments[0].constructor(u);for(o=0,f=0;o<p;o++)y.set(arguments[o],f),f+=arguments[o].length;return y},r.indices=function(u){for(var o=r.getPointerArray(u),f=new o(u),p=0;p<u;p++)f[p]=p;return f}})(j);var U={},Y=B,q=j;function ft(r){return Array.isArray(r)||q.isTypedArray(r)}function V(r){if(typeof r.length=="number")return r.length;if(typeof r.size=="number")return r.size}function ct(r){var t=V(r),e=typeof t=="number"?new Array(t):[],n=0;return Y(r,function(i){e[n++]=i}),e}function lt(r){var t=V(r),e=typeof t=="number"?q.getPointerArray(t):Array,n=typeof t=="number"?new Array(t):[],i=typeof t=="number"?new e(t):[],s=0;return Y(r,function(a){n[s]=a,i[s]=s++}),[n,i]}U.isArrayLike=ft;U.guessLength=V;U.toArray=ct;U.toArrayWithIndices=lt;var k=at,dt=B,pt=j,yt=U;function A(r,t,e){if(arguments.length<2&&(e=r,r=null,t=null),this.capacity=e,typeof this.capacity!="number"||this.capacity<=0)throw new Error("mnemonist/lru-cache: capacity should be positive number.");if(!isFinite(this.capacity)||Math.floor(this.capacity)!==this.capacity)throw new Error("mnemonist/lru-cache: capacity should be a finite positive integer.");var n=pt.getPointerArray(e);this.forward=new n(e),this.backward=new n(e),this.K=typeof r=="function"?new r(e):new Array(e),this.V=typeof t=="function"?new t(e):new Array(e),this.size=0,this.head=0,this.tail=0,this.items={}}A.prototype.clear=function(){this.size=0,this.head=0,this.tail=0,this.items={}};A.prototype.splayOnTop=function(r){var t=this.head;if(this.head===r)return this;var e=this.backward[r],n=this.forward[r];return this.tail===r?this.tail=e:this.backward[n]=e,this.forward[e]=n,this.backward[t]=r,this.head=r,this.forward[r]=t,this};A.prototype.set=function(r,t){var e=this.items[r];if(typeof e<"u"){this.splayOnTop(e),this.V[e]=t;return}this.size<this.capacity?e=this.size++:(e=this.tail,this.tail=this.backward[e],delete this.items[this.K[e]]),this.items[r]=e,this.K[e]=r,this.V[e]=t,this.forward[e]=this.head,this.backward[this.head]=e,this.head=e};A.prototype.setpop=function(r,t){var e=null,n=null,i=this.items[r];return typeof i<"u"?(this.splayOnTop(i),e=this.V[i],this.V[i]=t,{evicted:!1,key:r,value:e}):(this.size<this.capacity?i=this.size++:(i=this.tail,this.tail=this.backward[i],e=this.V[i],n=this.K[i],delete this.items[n]),this.items[r]=i,this.K[i]=r,this.V[i]=t,this.forward[i]=this.head,this.backward[this.head]=i,this.head=i,n?{evicted:!0,key:n,value:e}:null)};A.prototype.has=function(r){return r in this.items};A.prototype.get=function(r){var t=this.items[r];if(!(typeof t>"u"))return this.splayOnTop(t),this.V[t]};A.prototype.peek=function(r){var t=this.items[r];if(!(typeof t>"u"))return this.V[t]};A.prototype.forEach=function(r,t){t=arguments.length>1?t:this;for(var e=0,n=this.size,i=this.head,s=this.K,a=this.V,h=this.forward;e<n;)r.call(t,a[i],s[i],this),i=h[i],e++};A.prototype.keys=function(){var r=0,t=this.size,e=this.head,n=this.K,i=this.forward;return new k(function(){if(r>=t)return{done:!0};var s=n[e];return r++,r<t&&(e=i[e]),{done:!1,value:s}})};A.prototype.values=function(){var r=0,t=this.size,e=this.head,n=this.V,i=this.forward;return new k(function(){if(r>=t)return{done:!0};var s=n[e];return r++,r<t&&(e=i[e]),{done:!1,value:s}})};A.prototype.entries=function(){var r=0,t=this.size,e=this.head,n=this.K,i=this.V,s=this.forward;return new k(function(){if(r>=t)return{done:!0};var a=n[e],h=i[e];return r++,r<t&&(e=s[e]),{done:!1,value:[a,h]}})};typeof Symbol<"u"&&(A.prototype[Symbol.iterator]=A.prototype.entries);A.prototype.inspect=function(){for(var r=new Map,t=this.entries(),e;e=t.next(),!e.done;)r.set(e.value[0],e.value[1]);return Object.defineProperty(r,"constructor",{value:A,enumerable:!1}),r};typeof Symbol<"u"&&(A.prototype[Symbol.for("nodejs.util.inspect.custom")]=A.prototype.inspect);A.from=function(r,t,e,n){if(arguments.length<2){if(n=yt.guessLength(r),typeof n!="number")throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else arguments.length===2&&(n=t,t=null,e=null);var i=new A(t,e,n);return dt(r,function(s,a){i.set(a,s)}),i};var mt=A,C=mt,vt=B,wt=j,gt=U;function _(r,t,e){arguments.length<2?C.call(this,r):C.call(this,r,t,e);var n=wt.getPointerArray(this.capacity);this.deleted=new n(this.capacity),this.deletedSize=0}for(var $ in C.prototype)_.prototype[$]=C.prototype[$];typeof Symbol<"u"&&(_.prototype[Symbol.iterator]=C.prototype[Symbol.iterator]);_.prototype.clear=function(){C.prototype.clear.call(this),this.deletedSize=0};_.prototype.set=function(r,t){var e=this.items[r];if(typeof e<"u"){this.splayOnTop(e),this.V[e]=t;return}this.size<this.capacity?(this.deletedSize>0?e=this.deleted[--this.deletedSize]:e=this.size,this.size++):(e=this.tail,this.tail=this.backward[e],delete this.items[this.K[e]]),this.items[r]=e,this.K[e]=r,this.V[e]=t,this.forward[e]=this.head,this.backward[this.head]=e,this.head=e};_.prototype.setpop=function(r,t){var e=null,n=null,i=this.items[r];return typeof i<"u"?(this.splayOnTop(i),e=this.V[i],this.V[i]=t,{evicted:!1,key:r,value:e}):(this.size<this.capacity?(this.deletedSize>0?i=this.deleted[--this.deletedSize]:i=this.size,this.size++):(i=this.tail,this.tail=this.backward[i],e=this.V[i],n=this.K[i],delete this.items[n]),this.items[r]=i,this.K[i]=r,this.V[i]=t,this.forward[i]=this.head,this.backward[this.head]=i,this.head=i,n?{evicted:!0,key:n,value:e}:null)};_.prototype.delete=function(r){var t=this.items[r];if(typeof t>"u")return!1;if(delete this.items[r],this.size===1)return this.size=0,this.head=0,this.tail=0,this.deletedSize=0,!0;var e=this.backward[t],n=this.forward[t];return this.head===t&&(this.head=n),this.tail===t&&(this.tail=e),this.forward[e]=n,this.backward[n]=e,this.size--,this.deleted[this.deletedSize++]=t,!0};_.prototype.remove=function(r,t=void 0){var e=this.items[r];if(typeof e>"u")return t;var n=this.V[e];if(delete this.items[r],this.size===1)return this.size=0,this.head=0,this.tail=0,this.deletedSize=0,n;var i=this.backward[e],s=this.forward[e];return this.head===e&&(this.head=s),this.tail===e&&(this.tail=i),this.forward[i]=s,this.backward[s]=i,this.size--,this.deleted[this.deletedSize++]=e,n};_.from=function(r,t,e,n){if(arguments.length<2){if(n=gt.guessLength(r),typeof n!="number")throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else arguments.length===2&&(n=t,t=null,e=null);var i=new _(t,e,n);return vt(r,function(s,a){i.set(a,s)}),i};var At=_;const bt=H(At);function Mt(r){const{liveDocument:t,controller:e,perspective:n,documentsOnPage:i,onLoadersConnection:s,onDocumentsOnPage:a}=r,[h,u]=w.useState(),[o,f]=w.useState({}),p=Q(),y=W();w.useEffect(()=>{const b=setInterval(()=>f(c=>{if(Object.keys(c).length<1)return c;const R=Date.now();if(!Object.values(c).some(P=>P.heartbeat!==!1&&R>P.receivedAt+P.heartbeat))return c;const E={};for(const[P,M]of Object.entries(c))M.heartbeat!==!1&&R>M.receivedAt+M.heartbeat||(E[P]=M);return E}),L);return()=>clearInterval(b)},[]),w.useEffect(()=>{if(e){const b=e.createConnection({name:"presentation",connectTo:"loaders",heartbeat:!0},et().provide({actors:rt()}));return u(b),b.onStatus(s),b.on("loader/documents",c=>{c.projectId===p&&c.dataset===y&&a("loaders",c.perspective,c.documents)}),b.on("loader/query-listen",c=>{if(c.projectId===p&&c.dataset===y){if(typeof c.heartbeat=="number"&&c.heartbeat<L)throw new Error(`Loader query listen heartbeat interval must be at least ${L}ms`);f(R=>({...R,[it(c.query,c.params)]:{perspective:c.perspective,query:c.query,params:c.params,receivedAt:Date.now(),heartbeat:c.heartbeat??!1}}))}}),b.start()}},[e,y,a,s,p]);const[v]=w.useState(()=>new bt(Z)),m=J({apiVersion:"2023-10-16"}),d=w.useMemo(()=>m.config(),[m]),l=w.useMemo(()=>m.withConfig({resultSourceMap:"withKeyArraySelector"}),[m]);w.useEffect(()=>{if(h){const{projectId:b,dataset:c}=d;h.post({type:"loader/perspective",data:{projectId:b,dataset:c,perspective:n}})}},[h,d,n]);const S=w.useMemo(()=>{const b=i.map(({_id:E})=>E),c=[...new Set(b)],R=v.capacity;return c.length>=R&&(c.length=R),c},[v.capacity,i]),[g,I]=w.useState(0);return z.jsxs(z.Fragment,{children:[z.jsx(It,{cache:v,client:l,turboIds:S,setDocumentsCacheLastUpdated:I}),Object.entries(o).map(([b,{query:c,params:R,perspective:E}])=>z.jsx(St,{cache:v,projectId:d.projectId,dataset:d.dataset,perspective:E,query:c,params:R,comlink:h,client:l,refreshInterval:n?2e3:0,liveDocument:t,documentsCacheLastUpdated:g},`${b}${E}`))]})}const It=w.memo(function(r){const t=O(22),{cache:e,client:n,turboIds:i,setDocumentsCacheLastUpdated:s}=r;let a;t[0]===Symbol.for("react.memo_cache_sentinel")?(a=[],t[0]=a):a=t[0];const[h,u]=w.useState(a);let o,f;t[1]!==h||t[2]!==e||t[3]!==i?(o=()=>{const d=new Set(h.flat()),l=new Set;for(const g of i)!d.has(g)&&!e.has(g)&&l.add(g);const S=[...l].slice(0,D);S.length!==0&&u(g=>[...g.slice(-D),S])},f=[h,e,i],t[1]=h,t[2]=e,t[3]=i,t[4]=o,t[5]=f):(o=t[4],f=t[5]),w.useEffect(o,f);let p,y;t[6]!==e||t[7]!==n||t[8]!==s?(p=()=>{const d=n.listen("*",{},{events:["mutation"],effectFormat:"mendoza",includePreviousRevision:!1,includeResult:!1,tag:"presentation-loader"}).subscribe(l=>{var g,I;if(l.type==="mutation"&&l.transition==="disappear"&&e.delete(l.documentId)&&s(Date.now()),l.type!=="mutation"||!((I=(g=l.effects)==null?void 0:g.apply)!=null&&I.length))return;const S=e.peek(l.documentId);if(S){const b={...S};delete b._rev;const c=tt(b,l.effects.apply);e.set(l.documentId,c),s(Date.now())}});return()=>d.unsubscribe()},y=[e,n,s],t[6]=e,t[7]=n,t[8]=s,t[9]=p,t[10]=y):(p=t[9],y=t[10]),w.useEffect(p,y);let v;if(t[11]!==h||t[12]!==e||t[13]!==n||t[14]!==s){let d;t[16]!==e||t[17]!==n||t[18]!==s?(d=l=>z.jsx(K,{cache:e,client:n,ids:l,setDocumentsCacheLastUpdated:s},JSON.stringify(l)),t[16]=e,t[17]=n,t[18]=s,t[19]=d):d=t[19],v=h.map(d),t[11]=h,t[12]=e,t[13]=n,t[14]=s,t[15]=v}else v=t[15];let m;return t[20]!==v?(m=z.jsx(z.Fragment,{children:v}),t[20]=v,t[21]=m):m=t[21],m}),K=w.memo(function(r){const t=O(6),{client:e,cache:n,ids:i,setDocumentsCacheLastUpdated:s}=r;let a,h;return t[0]!==n||t[1]!==e||t[2]!==i||t[3]!==s?(a=()=>{const u=i.filter(o=>!n.has(o));u.length!==0&&e.getDocuments(u).then(o=>{for(const f of o)f&&(f!=null&&f._id)&&(n.set(f._id,f),s(Date.now()))},console.error)},h=[n,e,i,s],t[0]=n,t[1]=e,t[2]=i,t[3]=s,t[4]=a,t[5]=h):(a=t[4],h=t[5]),w.useEffect(a,h),null});K.displayName="GetDocuments";function St(r){const t=O(20),{cache:e,projectId:n,dataset:i,perspective:s,query:a,client:h,refreshInterval:u,liveDocument:o,comlink:f,documentsCacheLastUpdated:p}=r,y=nt(r.params);let v;t[0]!==e||t[1]!==h||t[2]!==p||t[3]!==o||t[4]!==y||t[5]!==s||t[6]!==a||t[7]!==u?(v={cache:e,client:h,liveDocument:o,params:y,perspective:s,query:a,refreshInterval:u,documentsCacheLastUpdated:p},t[0]=e,t[1]=h,t[2]=p,t[3]=o,t[4]=y,t[5]=s,t[6]=a,t[7]=u,t[8]=v):v=t[8];const m=Et(v),d=m==null?void 0:m.result,l=m==null?void 0:m.resultSourceMap,S=m==null?void 0:m.tags;let g,I;return t[9]!==f||t[10]!==i||t[11]!==y||t[12]!==s||t[13]!==n||t[14]!==a||t[15]!==d||t[16]!==l||t[17]!==S?(g=()=>{l&&(f==null||f.post({type:"loader/query-change",data:{projectId:n,dataset:i,perspective:s,query:a,params:y,result:d,resultSourceMap:l,tags:S}}))},I=[f,i,y,s,n,a,d,l,S],t[9]=f,t[10]=i,t[11]=y,t[12]=s,t[13]=n,t[14]=a,t[15]=d,t[16]=l,t[17]=S,t[18]=g,t[19]=I):(g=t[18],I=t[19]),w.useEffect(g,I),null}function Et(r){const{cache:t,liveDocument:e,client:n,refreshInterval:i,query:s,params:a,perspective:h,documentsCacheLastUpdated:u}=r,[o,f]=w.useState(null),{projectId:p,dataset:y}=w.useMemo(()=>{const{projectId:g,dataset:I}=n.config();return{projectId:g,dataset:I}},[n]),[v,m]=w.useState(null);if(v)throw v;const[d,l]=st({refreshInterval:i}),S=d==="refresh"||d==="inflight";return w.useEffect(()=>{if(!S)return;let g=!1,I=!1;const b=new AbortController;async function c(){const{signal:E}=b;I=!0;const{result:P,resultSourceMap:M,syncTags:X}=await n.fetch(s,a,{tag:"presentation-loader",signal:E,perspective:h,filterResponse:!1});I=!1,E.aborted||(f({result:P,resultSourceMap:M,tags:X}),g=!0)}const R=l();return c().catch(E=>{I=!1,E.name!=="AbortError"&&m(E)}).finally(R),()=>{!g&&!I&&b.abort()}},[n,y,e,a,h,p,s,S,l]),w.useMemo(()=>u&&(o!=null&&o.resultSourceMap)?{result:Rt(t,e,o.result,h,o.resultSourceMap),resultSourceMap:o.resultSourceMap}:o,[t,u,e,h,o])}let N=!1;function Rt(r,t,e,n,i){if(n==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return ot(e,i,s=>{if(s._projectId){N||(console.warn("Cross dataset references are not supported yet, ignoring source document",s),N=!0);return}return t!=null&&t._id&&F(t._id)===F(s._id)?t:r.get(s._id)},(s,{previousValue:a})=>typeof s=="number"&&typeof a=="string"?`${s}`:s,n)}export{Mt as default,Rt as turboChargeResultIfSourceMap};
